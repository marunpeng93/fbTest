var request = require('request');

module.exports = function(app) {
    //
    // GET /bot
    // 
    app.get('/bot', function(request, response) {
        if (request.query['hub.mode'] === 'subscribe' && 
            request.query['hub.verify_token'] === "token") {            
            console.log("验证webhook");
            response.status(200).send(request.query['hub.challenge']);
        } else {
            console.error("验证失败。确保验证令牌匹配");
            response.sendStatus(403);          
        }  
    });

    app.post('/bot', function(request, response) {
        var data = request.body;
        console.log('收到机器人webhook', data);
        console.log(JSON.stringify(data))
         // 确保这是一个页面订阅
         if (data.object === 'page') {
             // 遍历每个条目——如果批处理，可能会有多个
             data.entry.forEach(function(entry) {
                var pageID = entry.id;
                var timeOfEvent = entry.time;
                 // 迭代每个消息传递事件
                 entry.messaging.forEach(function(event) {
                     if (event.message) {
                         receivedMessage(event);
                     } else if (event.game_play) {
                         receivedGameplay(event);
                     } else {
                         console.log("Webhook收到未知事件: ", event);
                     }
                 });
             });
         }
         response.sendStatus(200);
     });

    //处理玩家直接发送给游戏机器人的消息
    function receivedMessage(event) {
        console.log("处理玩家直接发送给游戏机器人的消息", event)
    }

    //在这里处理game_play(当玩家关闭游戏)事件
    function receivedGameplay(event) {
        console.log("game_play", event)
        // bot用户的页面范围ID
        var senderId = event.sender.id; 

        // FBInstant player ID
        var playerId = event.game_play.player_id; 

        // FBInstant context ID 
        var contextId = event.game_play.context_id;

        // 检查负载
        if (event.game_play.payload) {
            //
            // 变量有效载荷包含了数据集
            // FBInstant.setSessionData()
            //
            var payload = JSON.parse(event.game_play.payload);

            //bot只是“响应”收到的消息
            
            sendMessage(senderId, null, "Message to game client: '" + payload.message + "'", "Play now!", payload);
        }
    }

    function sendMessage(player, context, message, cta, payload) {
        var button = {
            type: "game_play",
            title: "button title"
        };

        if (context) {
            button.context = context;
        }
        if (payload) {
            button.payload = JSON.stringify(payload)
        }
        var messageData = {
            recipient: {
                id: player
            },
            message: {
                attachment: {
                    type: "template",
                    payload: {
                        template_type: "generic",
                        text:"text",
                        title: "payload title",
                        image: "data:image/png;base64,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",
                        elements: [
                            {
                                buttons: [button]
                            }
                        ]
                    }
                }
            }
        };
        callSendAPI(messageData);
    }

    function callSendAPI(messageData) {
        var graphApiUrl = 'https://graph.facebook.com/me/messages?access_token='+"EAACrdzvAj5oBAG0ABH1qRZCfHAKxSaPezTjFauG2keZAjYakvrdHTOwT3st16cZAZCPtWhuS0lb3r5Vhrj7wNP6b0XmIx2MhzX2g9rePCDOJBQOAxZA1he8FWa9ErnsDz816ewfLMkMTMOrNWUzZBxZAyYCZAOaf6vKuq79CGuxLKGrc26mSPJbL"
        request({
            url: graphApiUrl,
            method: "POST",
            json: true,  
            body: messageData
        }, function (error, response, body){
            console.error('send api returned', 'error', error, 'status code', response.statusCode, 'body', body);
        });
    }
}